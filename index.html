<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Battle Royale - Farcaster</title>
    <meta property="og:title" content="Bitcoin Battle Royale">
    <meta property="og:description" content="Real-time Bitcoin block prediction game with $Seconds token rewards">
    <meta property="og:image" content="/api/og">
    <meta property="fc:frame" content="vNext">
    <meta property="fc:frame:image" content="/api/og">
    <meta property="fc:frame:button:1" content="üéØ Predict Next Block">
    <meta property="fc:frame:button:2" content="üìä View Leaderboard">
    <meta property="fc:frame:button:3" content="üí∞ Check Rewards">
    <meta property="fc:frame:post_url" content="/api/frame">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        .header {
            margin-bottom: 40px;
        }
        .title {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .game-area {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        .current-block {
            font-size: 2em;
            margin-bottom: 20px;
        }
        .prediction-form {
            margin: 20px 0;
        }
        .input-field {
            padding: 15px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            margin: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-align: center;
        }
        .input-field::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .btn {
            background: #ff6b6b;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }
        .loading {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .footer {
            margin-top: 50px;
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">‚öîÔ∏è Bitcoin Battle Royale</h1>
            <p class="subtitle">Predict the next Bitcoin block and earn $Seconds tokens!</p>
        </div>

        <div class="game-area">
            <div class="current-block">
                <div>Current Block Height</div>
                <div id="current-block-height" class="loading">Loading...</div>
            </div>

            <div class="prediction-form">
                <input type="number" id="prediction-input" class="input-field" placeholder="Predict next block time (seconds)">
                <br>
                <button onclick="makePrediction()" class="btn">üéØ Make Prediction</button>
                <button onclick="checkRewards()" class="btn">üí∞ Check Rewards</button>
            </div>

            <div id="game-status"></div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>üèÜ Top Predictor</h3>
                <div id="top-predictor">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>üíé Total Rewards</h3>
                <div id="total-rewards">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>‚è±Ô∏è Next Block ETA</h3>
                <div id="next-block-eta">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>üë• Active Players</h3>
                <div id="active-players">Loading...</div>
            </div>
        </div>

        <div class="footer">
            <p>Built for Farcaster ‚Ä¢ Powered by $Seconds ‚Ä¢ Real-time Bitcoin data</p>
        </div>
    </div>

    <script>
        // Game state
        let currentBlock = 0;
        let userPrediction = null;
        let gameActive = true;

        // Initialize the game
        async function initGame() {
            try {
                await fetchCurrentBlock();
                await fetchGameStats();
                startBlockMonitoring();
            } catch (error) {
                console.error('Failed to initialize game:', error);
                document.getElementById('game-status').innerHTML = '‚ùå Failed to connect to Bitcoin network';
            }
        }

        // Fetch current Bitcoin block height
        async function fetchCurrentBlock() {
            try {
                // This would connect to your backend API
                const response = await fetch('/api/bitcoin/current-block');
                const data = await response.json();
                currentBlock = data.height;
                document.getElementById('current-block-height').textContent = currentBlock.toLocaleString();
                document.getElementById('current-block-height').classList.remove('loading');
            } catch (error) {
                console.error('Error fetching block:', error);
                // Fallback to a mock block height for demo
                currentBlock = 867234; // Example block height
                document.getElementById('current-block-height').textContent = currentBlock.toLocaleString();
                document.getElementById('current-block-height').classList.remove('loading');
            }
        }

        // Make a prediction
        async function makePrediction() {
            const predictionInput = document.getElementById('prediction-input');
            const prediction = parseInt(predictionInput.value);
            
            if (!prediction || prediction < 1 || prediction > 1200) {
                alert('Please enter a valid prediction (1-1200 seconds)');
                return;
            }

            try {
                // This would send to your backend
                const response = await fetch('/api/prediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        blockHeight: currentBlock + 1,
                        prediction: prediction,
                        timestamp: Date.now()
                    })
                });

                if (response.ok) {
                    userPrediction = prediction;
                    predictionInput.value = '';
                    document.getElementById('game-status').innerHTML = 
                        `‚úÖ Prediction submitted: ${prediction} seconds for block ${currentBlock + 1}`;
                } else {
                    throw new Error('Failed to submit prediction');
                }
            } catch (error) {
                console.error('Error making prediction:', error);
                document.getElementById('game-status').innerHTML = 
                    `‚ö†Ô∏è Demo Mode: Predicted ${prediction} seconds for block ${currentBlock + 1}`;
            }
        }

        // Check rewards
        async function checkRewards() {
            try {
                const response = await fetch('/api/rewards');
                const data = await response.json();
                alert(`üí∞ Your rewards: ${data.totalRewards} $Seconds tokens`);
            } catch (error) {
                alert('üí∞ Demo Mode: You have 42.5 $Seconds tokens!');
            }
        }

        // Fetch game statistics
        async function fetchGameStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('top-predictor').textContent = stats.topPredictor || 'Anonymous';
                document.getElementById('total-rewards').textContent = `${stats.totalRewards || '1,337'} $Seconds`;
                document.getElementById('next-block-eta').textContent = `~${stats.nextBlockEta || '10'} min`;
                document.getElementById('active-players').textContent = stats.activePlayers || '42';
            } catch (error) {
                // Demo data
                document.getElementById('top-predictor').textContent = 'CryptoMaster';
                document.getElementById('total-rewards').textContent = '1,337 $Seconds';
                document.getElementById('next-block-eta').textContent = '~10 min';
                document.getElementById('active-players').textContent = '42';
            }
        }

        // Monitor for new blocks
        function startBlockMonitoring() {
            setInterval(async () => {
                const oldBlock = currentBlock;
                await fetchCurrentBlock();
                
                if (currentBlock > oldBlock) {
                    // New block found!
                    if (userPrediction) {
                        // Calculate if prediction was correct
                        // This would normally check against actual block time
                        document.getElementById('game-status').innerHTML = 
                            `üéâ New block ${currentBlock}! Checking your prediction...`;
                        
                        setTimeout(() => {
                            const won = Math.random() > 0.7; // 30% win rate for demo
                            if (won) {
                                document.getElementById('game-status').innerHTML = 
                                    `üèÜ Congratulations! You won 10 $Seconds tokens!`;
                            } else {
                                document.getElementById('game-status').innerHTML = 
                                    `üòî Close! Try again with the next block.`;
                            }
                            userPrediction = null;
                        }, 2000);
                    }
                    
                    // Update stats
                    await fetchGameStats();
                }
            }, 30000); // Check every 30 seconds
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initGame);

        // Handle Farcaster frame interactions
        if (window.parent !== window) {
            // We're in a frame, handle frame-specific logic
            console.log('Running in Farcaster frame');
        }
    </script>
</body>
</html>
